{% extends 'chama/chama_base.html' %}
{% load static %}
{% block title %}My Chamas - SmartChama{% endblock %}
{% block content %}
<div class="my-chamas-container">
    <div class="page-header">
        <h1 class="chama-page-title">My Chamas</h1>
        <div class="header-actions">
            <a href="" class="btn btn-outline">
                <span>ðŸ“±</span> Join via Code
            </a>
            <a href="{% url 'chama:create_chama' %}" class="btn btn-primary">
                <span>âž•</span> New Chama
            </a>
        </div>
    </div>

    <div class="chamas-table-wrapper">
        <table class="table chama-table">
          <thead>
            <tr>
                <th class="chama-th">Chama</th>
                <th class="chama-th">Members</th>
                <th class="chama-th">Contribution Progress</th>
                <th class="chama-th">Frequency</th>
                <th class="chama-th">Action</th>
            </tr>
          </thead>
          <tbody>
            {% for chama in chamas %}
            <tr class="chama-row">
              <td>
                <div class="chama-name-cell">
                    {% if chama.chama_logo %}
                    <img src="" alt="{{ chama.chama_name }}" class="chama-avatar">
                    {% else %}
                    <div class="chama-avatar-placeholder">
                        {{ chama.chama_name|slice:":2"|upper }}
                    </div>
                    {% endif %}
                    <div class="chama-info-cell">
                        <h3>{{ chama.chama_name }}</h3>
                        <p> 
                          {% if chama.chama_target_amount %}
                            Target: KES {{ chama.chama_target_amount|floatformat:0 }}
                          {% else %}
                            Target: KES N/A
                          {% endif %}
                        </p>
                    </div>
                </div>
              </td>
              <td>{{ chama.member_count }} / {{ chama.max_members }}</td>
              <td>
                <div class="progress-container">
                    {% if chama.chama_target_amount %}
                    {% widthratio chama.chama_total_contributions chama.chama_target_amount 100 as progress_percent %}
                    <div class="progress-text">
                        <span>KES {{ chama.chama_total_contributions|floatformat:0|default:"0" }}</span>
                        <span>{{ progress_percent }}%</span>
                    </div>
                    {% with rounded=progress_percent|add:"5"|divisibleby:10|stringformat:"d" %}
                    <div class="chama-progress">
                        <div class="progress-bar-fill progress-{{ rounded }}"></div>
                    </div>
                    {% endwith %}

                    {% else %}
                    <span class="text-muted">No target set</span>
                    {% endif %}
                </div>
              </td>
              <td>
                  <span class="badge badge-{{ chama.chama_contribution_frequency|lower }}">
                      {{ chama.chama_contribution_frequency }}
                  </span>
              </td>
              <td>
                  <button class="toggle-btn" data-chama-id="{{ chama.id }}">View Members</button>
              </td>
            </tr>
            <tr class="members-panel" id="members-{{ chama.id }}">
              <td colspan="5">
                <div class="members-content">
                  <h4 class="member-section-title">{{chama.chama_name}} Chama Members</h4>
                    {% if chama.all_members %}
                    <div class="members-table-wrapper">
                      <table class="table members-table">
                        <thead>
                          <tr>
                              <th>Profile</th>
                              <th>Name</th>
                              <th>Role</th>
                              <th>Contribution</th>
                              <th>Status</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for member in chama.all_members %}
                          <tr>
                            <td>
                                {% if member.membership_user.user_profile_picture %}
                                  <img src="{{ member.membership_user.user_profile_picture.url }}" 
                                       alt="{{ member.membership_user.get_full_name }}" 
                                       class="member-profile-pic">
                                {% else %}
                                  <div class="member-avatar-placeholder">
                                      {{ member.membership_user.user_first_name|slice:":1"|upper }}{{ member.membership_user.user_last_name|slice:":1"|upper }}
                                  </div>
                                {% endif %}
                            </td>
                            <td class="member-name">
                                {{ member.membership_user.user_first_name|default:member.membership_user.user_email }}
                                {{ member.membership_user.user_last_name|default:member.membership_user.user_email }}
                            </td>
                            <td>
                              <span class="member-role-badge">
                                  {{ member.membership_role|default:"Member" }}
                              </span>
                            </td>
                            <td class="member-contribution">
                                KES {{ member.membership_total_contribution|floatformat:0|default:"0" }}
                            </td>
                            <td>
                              <span class="status-badge status-{{ member.membership_status|lower }}">
                                  {{ member.membership_status }}
                              </span>
                            </td>
                          </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                    {% else %}
                      <p class="no-members">No members found in this chama.</p>
                    {% endif %}
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="5" class="text-center py-5">
                    <p class="no-chamas-msg">You haven't joined any chamas yet.</p>
                    <a href="{% url 'chama:create_chama' %}" class="btn btn-primary mt-3">Create Your First Chama</a>
                </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
    </div>
</div>

{% endblock %}