{% extends 'dashboard/dashboard_base.html' %}
{% load humanize %}

{% block title %}Treasurer Dashboard - {{ chama.chama_name }}{% endblock %}
{% block header %}Treasurer Dashboard{% endblock %}

{# --- Search bar goes in the topbar block, not inside content --- #}
{% block topbar %}
    {% if active_chama %}
    <form method="get" action="{% url 'dashboard:dashboard_search' active_chama.id %}" class="d-none d-md-block me-3">
        <div class="input-group search-bar bg-white rounded-pill px-3 py-1 shadow-sm">
            <span class="input-group-text border-0 bg-transparent p-0">
                <i class="fas fa-search text-muted small"></i>
            </span>
            <input type="text" name="q" class="form-control border-0 bg-transparent shadow-none small" placeholder="Search members...">
        </div>
    </form>
    {% endif %}
{% endblock %}

{% block content %}


<!-- ================= TOP FINANCIAL STATS ================= -->
<div class="row g-4 mb-4">
    <div class="col-lg-4 col-md-6">
        <div class="card-base d-flex align-items-center">
            <div class="icon-circle bg-light text-success me-3">
                <i class="fas fa-coins"></i>
            </div>
            <div>
                <small class="text-muted fw-bold text-uppercase">Total Collected</small>
                <h3 class="fw-bold mb-0">Ksh {{ total_funds|intword }}</h3>
            </div>
        </div>
    </div>

    <div class="col-lg-4 col-md-6">
        <div class="card-base d-flex align-items-center">
            <div class="icon-circle bg-light text-warning me-3">
                <i class="fas fa-hand-holding-usd"></i>
            </div>
            <div>
                <small class="text-muted fw-bold text-uppercase">Active Loans</small>
                <h3 class="fw-bold mb-0">{{ active_loans_count }}</h3>
            </div>
        </div>
    </div>

    <div class="col-lg-4 col-md-12">
        <div class="card-base d-flex align-items-center">
            <div class="icon-circle bg-light text-danger me-3">
                <i class="fas fa-gavel"></i>
            </div>
            <div>
                <small class="text-muted fw-bold text-uppercase">Total Penalties</small>
                <h3 class="fw-bold mb-0">Ksh {{ total_penalties|intcomma }}</h3>
            </div>
        </div>
    </div>
</div>

<!-- ================= ATTENTION ================= -->
<h6 class="text-muted fw-bold text-uppercase small mb-3">Attention Needed</h6>

<div class="row g-4 mb-4">
    <div class="col-lg-4 col-md-6">
        <div class="card-base card-attention border-orange">
            <small class="fw-bold text-warning">
                <i class="fas fa-clock me-1"></i> PENDING CONTRIBUTIONS
            </small>
            <h2 class="fw-bold mt-2 mb-0">{{ pending_count }}</h2>
            <small class="text-muted">Expected: Ksh {{ pending_amount|intcomma }}</small>
        </div>
    </div>

    <div class="col-lg-4 col-md-6">
        <div class="card-base card-attention border-purple">
            <small class="fw-bold text-purple">
                <i class="fas fa-file-invoice-dollar me-1"></i> LOAN REQUESTS
            </small>
            <h2 class="fw-bold mt-2 mb-0">{{ pending_loans.count }}</h2>
            <small class="text-muted">Awaiting approval</small>
        </div>
    </div>

    <div class="col-lg-4 col-md-12">
        <div class="card-base card-attention border-blue">
            <small class="fw-bold text-primary">
                <i class="fas fa-exclamation-triangle me-1"></i> DEFAULTS
            </small>
            <h2 class="fw-bold mt-2 mb-0">{{ loan_defaults }}</h2>
            <small class="text-muted">Loan penalties</small>
        </div>
    </div>
</div>

<!-- ================= STK + GOAL ================= -->
<div class="row g-4 mb-4">
    <div class="col-lg-4">
        <div class="card-base card-dark">
            <div class="d-flex justify-content-between mb-3">
                <h6 class="fw-bold mb-0">Todayâ€™s STK</h6>
                <i class="fas fa-mobile-alt text-white-muted"></i>
            </div>
            <div class="d-flex justify-content-between text-center">
                <div>
                    <h4 class="text-success fw-bold mb-0">{{ stk_success }}</h4>
                    <small class="text-white-muted">Success</small>
                </div>
                <div>
                    <h4 class="text-danger fw-bold mb-0">{{ stk_failed }}</h4>
                    <small class="text-white-muted">Failed</small>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-8">
        <div class="card-base">
            <div class="d-flex justify-content-between mb-2">
                <h6 class="fw-bold mb-0">Chama Goal Progress</h6>
                <span class="badge bg-success">{{ progress_percent|floatformat:0 }}%</span>
            </div>
            <h4 class="fw-bold">Ksh {{ collected|intword }}</h4>
            <small class="text-muted">Target: Ksh {{ target|intword }}</small>
            <div class="progress mt-2" style="height:6px;">
                <div class="progress-bar bg-success" style="width: {{ progress_percent }}%;"></div>
            </div>
        </div>
    </div>
</div>

<!-- ================= CHARTS ================= -->
<div class="row g-4">
    <div class="col-lg-8">
        <div class="card-base">
            <h6 class="fw-bold mb-3">Contribution History</h6>
            <div style="height:300px;">
                <canvas id="contributionChart"></canvas>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card-base">
            <h6 class="fw-bold mb-3">Cycle Status</h6>
            {% if cycle_status.paid or cycle_status.pending or cycle_status.overdue %}
            <div style="height:250px;">
                <canvas id="cycleChart"></canvas>
            </div>
            {% else %}
            <div class="text-center py-5 text-muted">
                <i class="fas fa-info-circle fa-2x mb-2"></i>
                <p>No cycle data available yet.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{{ contributions_history|json_script:"history-data" }}
{{ cycle_status|json_script:"cycle-data" }} 

<script>
document.addEventListener('DOMContentLoaded', function() {
    // ---------------------------------------------
    // 1. Contribution History Chart
    // ---------------------------------------------
    const historyEl = document.getElementById("history-data");
    const history = historyEl ? JSON.parse(historyEl.textContent) : [];

    const contributionCtx = document.getElementById("contributionChart");
    if (contributionCtx) {
        new Chart(contributionCtx, {
            type: "line",
            data: {
                labels: history.map(h => `Month ${h.contribution_time__month}`),
                datasets: [{
                    data: history.map(h => h.total),
                    borderColor: "#10b981",
                    backgroundColor: "rgba(16, 185, 129, 0.2)",
                    borderWidth: 2,
                    fill: true,
                    tension: .4
                }]
            },
            options: {
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true } }
            }
        });
    }

    // ---------------------------------------------
    // 2. Cycle Status Chart
    // ---------------------------------------------
    // Get the data safely from the JSON script tag
    const cycleEl = document.getElementById("cycle-data");
    const cycleData = cycleEl ? JSON.parse(cycleEl.textContent) : {};

    const cycleCtx = document.getElementById("cycleChart");
    if (cycleCtx) {
        // Prepare data with fallbacks to 0
        const paid = cycleData.paid || 0;
        const pending = cycleData.pending || 0;
        const overdue = cycleData.overdue || 0;

        new Chart(cycleCtx, {
            type: "doughnut",
            data: {
                labels: ["Paid", "Pending", "Overdue"],
                datasets: [{
                    data: [paid, pending, overdue],
                    backgroundColor: ["#10b981", "#f59e0b", "#ef4444"],
                    borderWidth: 0
                }]
            },
            options: {
                cutout: "70%",
                plugins: {
                    legend: {
                        display: true,
                        position: "bottom",
                        labels: { color: "#6b7280", font: { size: 12 } }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(ctx) {
                                const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                const value = ctx.parsed;
                                const pct = total > 0 ? Math.round((value / total) * 100) : 0;
                                return `${ctx.label}: ${value} (${pct}%)`;
                            }
                        }
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}