{% extends "dashboard/dashboard_base.html" %}
{% load static humanize %}

{% block title %}Member Dashboard - {{ active_chama.chama_name }}{% endblock %}
{% block header %}Dashboard{% endblock %}

{% block content %}
<div class="row pt-5 mt-4">
    <div class="col-12">
        <h2 class="fw-bold text-dark">ðŸ‘‹ Welcome, Member!</h2>
        {% if active_chama %}
            <p class="text-muted">Overview for **{{ active_chama.chama_name }}**</p>
        {% else %}
             <p class="text-danger">Please select an active Chama from the sidebar to view your dashboard.</p>
        {% endif %}
    </div>
</div>

{% if active_chama %}
    <div class="row g-4 mt-3">
        
        <div class="col-xl-3 col-md-6">
            <div class="card-metric card-top-accent h-100">
                <div class="d-flex align-items-center mb-2">
                    <div class="icon-box bg-light-orange me-3">
                        <i class="fas fa-hand-holding-usd text-orange"></i>
                    </div>
                    <div class="text-uppercase text-muted fw-bold small">My Contribution Status</div>
                </div>
                <h3 class="mb-0 fw-bold text-{{ contrib_color }}">
                    {{ contrib_status|default:"N/A" }}
                </h3>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card-metric card-top-accent h-100">
                <div class="d-flex align-items-center mb-2">
                    <div class="icon-box bg-light-blue me-3">
                        <i class="fas fa-piggy-bank text-info"></i>
                    </div>
                    <div class="text-uppercase text-muted fw-bold small">My Loans (Outstanding)</div>
                </div>
                <h3 class="mb-0 fw-bold text-dark">
                    {% if active_loan %}
                        Ksh. {{ active_loan.loan_outstanding_balance|floatformat:0|intcomma }}
                    {% else %}
                        None Active
                    {% endif %}
                </h3>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card-metric card-top-accent h-100">
                <div class="d-flex align-items-center mb-2">
                    <div class="icon-box bg-light-danger me-3">
                        <i class="fas fa-exclamation-triangle text-danger"></i>
                    </div>
                    <div class="text-uppercase text-muted fw-bold small">Unpaid Penalties</div>
                </div>
                <h3 class="mb-0 fw-bold text-dark">
                    Ksh. {{ total_penalty_amount|floatformat:0|intcomma }}
                </h3>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card-metric card-top-accent h-100">
                <div class="d-flex align-items-center mb-2">
                    <div class="icon-box bg-light-purple me-3">
                        <i class="fas fa-calendar-alt text-purple"></i>
                    </div>
                    <div class="text-uppercase text-muted fw-bold small">Next Meeting</div>
                </div>
                <h5 class="mb-1 fw-bold text-dark">
                    {% if next_meeting %}
                        {{ next_meeting.meeting_date|date:"M d, H:i" }}
                    {% else %}
                        Not Scheduled
                    {% endif %}
                </h5>
                <small class="text-{{ attendance_status|lower|yesno:'success,warning,danger' }} fw-bold">
                    My Status: {{ attendance_status }}
                </small>
            </div>
        </div>
    </div>
    
    <div class="row g-4 mt-4">
        <div class="col-xl-8">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white fw-bold text-dark border-0">
                    <i class="fas fa-chart-line me-2"></i> My Contribution History (Last 6 Months)
                </div>
                <div class="card-body">
                    <div class="chart-area" style="height: 300px;">
                        <canvas id="myContributionChart" class="chart-canvas"
                                data-type="line"
                                data-label="Amount Contributed (Ksh)"
                                data-labels="{{ chart_labels }}"
                                data-data="{{ chart_data }}"
                                ></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-4">
            <div class="row g-4">
                <div class="col-12">
                    <div class="card-metric card-top-accent">
                        <div class="d-flex align-items-center mb-2">
                            <div class="icon-box bg-light-green me-3">
                                <i class="far fa-bell text-success"></i>
                            </div>
                            <div class="text-uppercase text-muted fw-bold small">Unread Notifications</div>
                        </div>
                        <h3 class="mb-2 fw-bold text-dark">{{ unread_count }}</h3>
                        <a href="{% url 'notification:notification_list' %}" class="small d-block text-primary">
                            View All Notifications <i class="fas fa-arrow-right small"></i>
                        </a>
                    </div>
                </div>

                <div class="col-12">
                    <div class="card-metric card-top-accent">
                        <div class="text-uppercase text-muted fw-bold small mb-2">Chama Target Progress (Ksh. {{ chama_target|floatformat:0|intcomma }})</div>
                        <h3 class="fw-bold text-orange mb-3">{{ chama_progress|floatformat:1 }}%</h3>
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar bg-orange" role="progressbar" style="width: {{ chama_progress|floatformat:0 }}%" aria-valuenow="{{ chama_progress|floatformat:0 }}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <small class="text-muted mt-2 d-block">
                            Total collected: Ksh. {{ total_collected|floatformat:0|intcomma }}
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endif %}
{% endblock content %}

{% block extra_js %}
{% endblock %}