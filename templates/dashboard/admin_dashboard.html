{% extends 'dashboard/dashboard_base.html' %}
{% load static %}

{% block title %}Admin Dashboard - {{ active_chama.chama_name }}{% endblock %}
{% block header %}Admin Dashboard - {{ active_chama.chama_name }}{% endblock %}

{% block content %}
<!-- Metrics Cards Grid -->
<div class="row g-4 mb-4">
    <!-- 1. Total Members -->
    <div class="col-xl-3 col-lg-4 col-md-6">
        <div class="card-metric card-top-accent">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                    <p class="text-muted small mb-1">TOTAL MEMBERS</p>
                    <h2 class="fw-bold mb-0">{{ total_members }}</h2>
                </div>
                <div class="icon-box bg-light text-primary">
                    <i class="fas fa-users"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. Total Contributions -->
    <div class="col-xl-3 col-lg-4 col-md-6">
        <div class="card-metric card-top-accent">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                    <p class="text-muted small mb-1">TOTAL CONTRIBUTIONS</p>
                    <h2 class="fw-bold mb-0">Ksh {{ total_contributions|floatformat:0 }}</h2>
                </div>
                <div class="icon-box bg-light text-success">
                    <i class="fas fa-hand-holding-usd"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. Pending Contributions -->
    <div class="col-xl-3 col-lg-4 col-md-6">
        <div class="card-metric card-top-accent">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                    <p class="text-muted small mb-1">PENDING CONTRIBUTIONS</p>
                    <h2 class="fw-bold mb-0">{{ pending_regular_count }}</h2>
                    <p class="text-muted small mb-0">Expected: Ksh {{ pending_regular_amount|floatformat:0 }}</p>
                </div>
                <div class="icon-box bg-light text-danger">
                    <i class="fas fa-users-slash"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. Pending Loan Requests -->
    <div class="col-xl-3 col-lg-4 col-md-6">
        <div class="card-metric card-top-accent">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                    <p class="text-muted small mb-1">PENDING LOAN REPAYMENTS</p>
                    <h2 class="fw-bold mb-0">{{ pending_loans_count }}</h2>
                </div>
                <div class="icon-box bg-light text-warning">
                    <i class="fas fa-money-check-alt"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. Today's STK Summary -->
    <div class="col-xl-3 col-lg-4 col-md-6">
        <div class="card-metric card-top-accent">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                    <p class="text-muted small mb-1">TODAY'S STK SUMMARY</p>
                    <div class="d-flex gap-3 mt-2">
                        <div>
                            <p class="mb-0 small text-muted">Success</p>
                            <h5 class="fw-bold text-success mb-0">{{ stk_success }}</h5>
                        </div>
                        <div>
                            <p class="mb-0 small text-muted">Failed</p>
                            <h5 class="fw-bold text-danger mb-0">{{ stk_failed }}</h5>
                        </div>
                        <div>
                            <p class="mb-0 small text-muted">Pending</p>
                            <h5 class="fw-bold text-warning mb-0">{{ stk_pending }}</h5>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 6. Penalties Overview -->
    <div class="col-xl-3 col-lg-4 col-md-6">
        <div class="card-metric card-top-accent">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                    <p class="text-muted small mb-1">PENALTIES OVERVIEW</p>
                    <h2 class="fw-bold mb-0">Ksh {{ total_penalty_amount|floatformat:2 }}</h2>
                    <p class="text-danger small mb-0">Unpaid: {{ unpaid_penalty_count }}</p>
                </div>
                <div class="icon-box bg-light text-danger">
                    <i class="fas fa-exclamation-circle"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- 7. Progress Toward Chama Target -->
    <div class="col-xl-6 col-lg-8 col-md-12">
        <div class="card-metric card-top-accent">
            <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <p class="text-muted small mb-0">GOAL PROGRESS</p>
                    <span class="badge bg-success">{{ progress_percent|floatformat:1 }}%</span>
                </div>
                <h4 class="fw-bold mb-1">Ksh {{ collected|floatformat:0 }} / Ksh {{ target|floatformat:0 }}</h4>
                <div class="progress" style="height: 12px;">
                    <div class="progress-bar bg-success" role="progressbar" style="width: {{ progress_percent }}%;" aria-valuenow="{{ progress_percent }}" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <p class="text-muted small mt-2 mb-0">Target: Ksh {{ target|floatformat:0 }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Charts and Activity Row -->
<div class="row g-4">
    <!-- Contribution History Chart -->
    <div class="col-lg-8">
        <div class="card-metric card-top-accent">
            <h5 class="fw-bold mb-4">Contributions (Last 6 Months)</h5>
            <div style="height: 300px; position: relative;">
                <canvas id="contributionChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="col-lg-4">
        <div class="card-metric card-top-accent">
            <h5 class="fw-bold mb-3">Recent Activity</h5>
            <div style="max-height: 300px; overflow-y: auto;">
                {% if recent_activities %}
                    {% for activity in recent_activities %}
                    <div class="activity-item">
                        <div class="activity-icon {{ activity.color }}">
                            <i class="fas {{ activity.icon }}"></i>
                        </div>
                        <div class="activity-content">
                            <p class="activity-description mb-0">{{ activity.description }}</p>
                            <small class="activity-time">{{ activity.timestamp|timesince }} ago</small>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-center text-muted py-4">No recent activity.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Contribution History Chart
    const ctx = document.getElementById('contributionChart');
    if (ctx) {
        const historyData = {{ contributions_history|safe }};
        
        const labels = historyData.map(item => {
            const date = new Date(item.month);
            return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
        });
        
        const data = historyData.map(item => parseFloat(item.total) || 0);
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Contributions (Ksh)',
                    data: data,
                    backgroundColor: 'rgba(34, 139, 34, 0.1)',
                    borderColor: '#228b22',
                    borderWidth: 2,
                    tension: 0.3,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { borderDash: [2, 4] }
                    },
                    x: {
                        grid: { display: false }
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}