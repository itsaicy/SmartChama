{% extends 'notification/notification_base.html' %}
{% load static %}
{% block title %}Notification Center{% endblock %}
{% block header_title %}Notification Center{% endblock %}

{% block content %}
<div class="mb-3">
  <div class="d-flex align-items-center gap-2 flex-wrap">
    <a href="?type=all{% if request.GET.chama %}&chama={{ request.GET.chama }}{% endif %}"
       class="filter-pill {% if filter_type == 'all' %}active{% endif %}">All</a>

    <a href="?type=announcements{% if request.GET.chama %}&chama={{ request.GET.chama }}{% endif %}"
       class="filter-pill {% if filter_type == 'announcements' %}active{% endif %}">Announcements</a>

    <a href="?type=targeted{% if request.GET.chama %}&chama={{ request.GET.chama }}{% endif %}"
       class="filter-pill {% if filter_type == 'targeted' %}active{% endif %}">Targeted</a>

    <form method="get" class="ms-2 d-flex align-items-center">
      <select name="chama" class="form-select form-select-sm" onchange="this.form.submit()">
        <option value="">All Chamas</option>
        {% for c in chamas %}
          <option value="{{ c.id }}"
                  {% if selected_chama_id == c.id|stringformat:'s' %}selected{% endif %}>
            {{ c.chama_name }}
          </option>
        {% endfor %}
      </select>
      <input type="hidden" name="type" value="{{ filter_type }}">
    </form>

    <div class="ms-auto small-muted">Unread: {{ unread_count }}</div>
  </div>
</div>

<div class="list-group">
  {% for n in notifications %}
    <div class="list-group-item notif-card d-flex align-items-start gap-3 {% if not n.notification_is_read %}accent{% endif %}">
      <div class="icon-box">
        <i class="bi bi-bell"></i>
      </div>

      <div class="flex-grow-1">
        <div class="d-flex justify-content-between">
          <div>
            <a href="{% url 'notification:notification_detail' n.id %}" class="fw-semibold text-decoration-none">
              {{ n.notification_title|default:n.notification_type|title }}
            </a>
            <div class="small-muted">
              {{ n.notification_chama.chama_name }} •
              {% if n.notification_sender %}
                {{ n.notification_sender.get_full_name|default:n.notification_sender.username }}
              {% else %}
                System
              {% endif %}
            </div>
          </div>
          <div class="text-end small-muted">
            <div>{{ n.notification_created_at|timesince }} ago</div>
            {% if not n.notification_is_read %}
              <span class="badge">New</span>
            {% endif %}
          </div>
        </div>
        <div class="mt-2 small-muted">{{ n.notification_message|truncatechars:120 }}</div>
      </div>

      <div class="ms-2 align-self-center d-flex flex-column gap-1">
        {% if not n.notification_is_read %}
          <form method="post" action="{% url 'notification:mark_as_read' n.id %}">
            {% csrf_token %}
            <button class="btn btn-sm" title="Mark as read">✓</button>
          </form>
        {% endif %}
        {% if n.notification_sender == request.user %}
          <a href="{% url 'notification:edit_notification' n.id %}" class="text-warning small" title="Edit">
            <i class="bi bi-pencil-square"></i>
          </a>
          <a href="{% url 'notification:delete_notification' n.id %}" class="text-danger small"
             onclick="return confirm('Delete this notification?');" title="Delete">
            <i class="bi bi-trash"></i>
          </a>
        {% endif %}
      </div>
    </div>
  {% empty %}
    <div class="notif-card text-center text-muted">No notifications.</div>
  {% endfor %}
</div>

<div class="d-flex justify-content-center mt-4">
  <nav aria-label="Page navigation">
    <ul class="pagination pagination-sm">
      {% if notifications.has_previous %}
        <li class="page-item">
          <a class="page-link"
             href="?page={{ notifications.previous_page_number }}{% if request.GET.chama %}&chama={{ request.GET.chama }}{% endif %}{% if filter_type %}&type={{ filter_type }}{% endif %}">
            Prev
          </a>
        </li>
      {% endif %}

      <li class="page-item disabled">
        <span class="page-link">{{ notifications.number }} / {{ notifications.paginator.num_pages }}</span>
      </li>

      {% if notifications.has_next %}
        <li class="page-item">
          <a class="page-link"
             href="?page={{ notifications.next_page_number }}{% if request.GET.chama %}&chama={{ request.GET.chama }}{% endif %}{% if filter_type %}&type={{ filter_type }}{% endif %}">
            Next
          </a>
        </li>
      {% endif %}
    </ul>
  </nav>
</div>

{% if active_chama %}
  <button id="create-btn" class="float-create js-float-create" title="Create">
    <strong>+</strong>
  </button>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/notification_list.js' %}" defer></script>
{% endblock %}
