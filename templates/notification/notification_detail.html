{% extends 'notification/notification_base.html' %}
{% load static %}
{% block title %}Notification Details{% endblock %}
{% block header_title %}Details{% endblock %}

{% block content %}
<div class="row">
  <div class="col-12">
    <div class="notif-card mb-3" data-notification-root>
      <div class="d-flex justify-content-between">
        <div>
          <div class="small-muted">
            From:
            {% if notification.notification_sender %}
              {{ notification.notification_sender.get_full_name|default:notification.notification_sender.username }}
            {% else %}
              System
            {% endif %}
          </div>
          <h4 class="mt-1 mb-1 text-warning">{{ notification.notification_title|default:"" }}</h4>
          <div class="small-muted">{{ notification.notification_created_at|date:"M d, Y H:i" }}</div>
        </div>
        <div class="text-end d-flex gap-2">
          {% if notification.notification_sender == request.user %}
            <button class="btn btn-sm btn-outline-light js-open-edit"
                    data-edit-url="{% url 'notification:edit_notification' notification.id %}">
              Edit
            </button>
            <a href="{% url 'notification:delete_notification' notification.id %}"
               class="btn btn-sm btn-danger"
               onclick="return confirm('Delete this notification?');">
              Delete
            </a>
          {% endif %}
        </div>
      </div>

      <hr class="my-3" />
      <p class="small-muted">{{ notification.notification_message }}</p>
    </div>

    <h6 class="mb-2">Replies</h6>
    <div class="mb-3" id="replies-container">
      {% for r in replies %}
        <div class="d-flex {% if r.notification_reply_user == request.user %}justify-content-end{% else %}justify-content-start{% endif %} mb-2">
          {% if r.notification_reply_user != request.user %}
            <div class="me-2 text-center" style="width:40px;">
              <img src="{{ r.notification_reply_user.profile.avatar_url|default:'/static/img/default-avatar.png' }}"
                   alt="" class="rounded-circle"
                   style="width:36px;height:36px;object-fit:cover;">
            </div>
          {% endif %}
          <div class="{% if r.notification_reply_user == request.user %}reply-right{% else %}reply-left{% endif %} max-w-75">
            <div class="d-flex justify-content-between align-items-center">
              <div class="small-muted">
                {{ r.notification_reply_user.get_full_name|default:r.notification_reply_user.username }}
                Â· <span class="small-muted">{{ r.notification_reply_created_at|naturaltime }}</span>
              </div>
              {% if r.notification_reply_user == request.user %}
                <div class="d-flex gap-2">
                  <a href="{% url 'notification:edit_reply' r.id %}" class="text-warning small" title="Edit">
                    <i class="bi bi-pencil-square"></i>
                  </a>
                  <a href="{% url 'notification:delete_reply' r.id %}" class="text-danger small"
                     onclick="return confirm('Delete this reply?');" title="Delete">
                    <i class="bi bi-trash"></i>
                  </a>
                </div>
              {% endif %}
            </div>
            <div>{{ r.notification_reply_message }}</div>
          </div>
          {% if r.notification_reply_user == request.user %}
            <div class="ms-2 text-center" style="width:36px;">
              <img src="{{ r.notification_reply_user.profile.avatar_url|default:'/static/img/default-avatar.png' }}"
                   alt="" class="rounded-circle"
                   style="width:36px;height:36px;object-fit:cover;">
            </div>
          {% endif %}
        </div>
      {% empty %}
        <div class="small-muted">No replies yet.</div>
      {% endfor %}
    </div>

    <form class="js-reply-form" method="post" action="{% url 'notification:notification_reply' notification.id %}">
      {% csrf_token %}
      <div class="input-group">
        <textarea name="reply_message" class="form-control" placeholder="Type your reply..." rows="1" required></textarea>
        <button class="btn btn-warning text-dark" type="submit">Send</button>
      </div>
    </form>
  </div>
</div>

<div class="modal fade js-edit-modal" id="editModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-white">
      <form method="post" class="p-3" action="{% url 'notification:edit_notification' notification.id %}">
        {% csrf_token %}
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title">Edit Notification</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <label class="form-label">Title</label>
          <input name="title" class="form-control mb-2" value="{{ notification.notification_title }}">
          <label class="form-label">Message</label>
          <textarea name="message" class="form-control" rows="5">{{ notification.notification_message }}</textarea>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-warning text-dark">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/notification_detail.js' %}" defer></script>
<script src="{% static 'js/notification_modal.js' %}" defer></script>
{% endblock %}
