{% extends 'notification/notification_base.html' %}
{% block header_title %}Details{% endblock %}

{% block content %}
<div class="notif-centered">
    
    <div class="notif-card mb-4 border-0 shadow-sm">
        <div class="d-flex justify-content-between align-items-start mb-2">
            <div class="d-flex align-items-center gap-2">
                <div class="rounded-circle bg-light d-flex align-items-center justify-content-center fw-bold text-muted border" 
                     style="width: 32px; height: 32px;">
                    {{ notification.notification_sender.user_first_name|first|default:"S" }}
                </div>
                <div class="small-muted">
                    <span class="fw-bold text-dark">{{ notification.notification_sender.get_full_name|default:"System" }}</span>
                    <br>
                    {{ notification.notification_chama.chama_name }}
                </div>
            </div>
            <span class="badge bg-light text-dark border">{{ notification.get_notification_type_display }}</span>
        </div>
        
        <h5 class="fw-bold mb-3 mt-2">{{ notification.notification_title }}</h5>
        <p class="text-dark mb-3" style="line-height: 1.6; white-space: pre-wrap;">{{ notification.notification_message }}</p>
        
        <div class="border-top pt-2 mt-2">
            <small class="small-muted">{{ notification.notification_created_at|date:"M d, Y â€¢ h:i A" }}</small>
        </div>
    </div>

    <div class="mb-2">
        <h6 class="fw-bold text-dark">Replies</h6>
    </div>

    <div class="replies-wrapper pb-5">
        {% for r in replies %}
        <div class="reply-container {% if r.notification_reply_user == request.user %}reply-right{% else %}reply-left{% endif %}">
            
            <div class="flex-shrink-0">
                {% if r.notification_reply_user.user_profile_picture %}
                    <img src="{{ r.notification_reply_user.user_profile_picture.url }}" class="rounded-circle border" width="32" height="32" style="object-fit:cover;">
                {% else %}
                    <div class="rounded-circle bg-white border d-flex align-items-center justify-content-center text-muted fw-bold small" style="width:32px; height:32px;">
                        {{ r.notification_reply_user.user_first_name|first }}
                    </div>
                {% endif %}
            </div>

            <div class="reply-box">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <div class="fw-bold" style="font-size: 0.75rem; opacity: 0.7;">
                        {{ r.notification_reply_user.user_first_name }}
                    </div>
                    
                    {% if r.notification_reply_user == request.user %}
                    <div class="d-flex gap-2">
                        <button onclick="toggleEdit('{{ r.id }}')" class="btn btn-link p-0 text-dark fw-bold" title="Edit">
                            <i class="bi bi-pencil-square" style="font-size: 1rem;"></i>
                        </button>
                        <a href="{% url 'notification:delete_reply' r.id %}" onclick="return confirm('Delete this reply?')" class="text-danger fw-bold" title="Delete">
                            <i class="bi bi-trash" style="font-size: 1rem;"></i>
                        </a>
                    </div>
                    {% endif %}
                </div>
                
                <div id="display-{{ r.id }}" class="mb-1">
                    {{ r.notification_reply_message }}
                </div>

                {% if r.notification_reply_user == request.user %}
                <div id="edit-tab-{{ r.id }}" style="display: none;" class="mt-2 p-2 bg-light rounded border">
                    <form action="{% url 'notification:save_reply_edit' r.id %}" method="post" id="form-{{ r.id }}">
                        {% csrf_token %}
                        <textarea name="content" class="form-control form-control-sm mb-2" rows="2">{{ r.notification_reply_message }}</textarea>
                        <div class="d-flex gap-2 justify-content-end">
                            <button type="button" onclick="toggleEdit('{{ r.id }}')" class="btn btn-sm btn-white border">Cancel</button>
                            <button type="button" onclick="submitEdit('{{ r.id }}')" class="btn btn-sm btn-dark">Save</button>
                        </div>
                    </form>
                </div>
                {% endif %}
                
                <div class="text-end mt-1" style="font-size: 0.65rem; opacity: 0.6;">
                    {{ r.notification_reply_created_at|date:"H:i" }}
                </div>
            </div>
        </div>
        {% empty %}
            <div class="text-center py-4 text-muted small bg-white rounded border border-light">
                No replies yet.
            </div>
        {% endfor %}
        <div style="height: 60px;"></div>
    </div>

</div>

{% if allow_replies %}
<div class="fixed-bottom-input shadow-lg">
    <div class="notif-centered">
        <form method="post" action="{% url 'notification:notification_reply' notification.id %}" class="d-flex gap-2 align-items-center px-3">
            {% csrf_token %}
            <textarea name="reply_message" class="form-control rounded-4 bg-light border-0" 
                      rows="1" placeholder="Type a reply..." style="resize:none; padding-left: 15px;" required></textarea>
            <button type="submit" class="btn btn-accent rounded-circle d-flex align-items-center justify-content-center flex-shrink-0 shadow-sm" style="width: 45px; height: 45px;">
                <i class="bi bi-send-fill"></i>
            </button>
        </form>
    </div>
</div>
{% else %}
<div class="fixed-bottom p-3 bg-light border-top text-center text-muted small">
    <i class="bi bi-lock-fill me-1"></i> Replies are disabled for this notification.
</div>
{% endif %}

<script>
function toggleEdit(id) {
    const display = document.getElementById(`display-${id}`);
    const tab = document.getElementById(`edit-tab-${id}`);
    if(tab.style.display === 'none') {
        tab.style.display = 'block';
        display.style.display = 'none';
    } else {
        tab.style.display = 'none';
        display.style.display = 'block';
    }
}

function submitEdit(id) {
    const form = document.getElementById(`form-${id}`);
    const formData = new FormData(form);
    
    fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {'X-Requested-With': 'XMLHttpRequest'}
    })
    .then(res => res.json())
    .then(data => {
        if(data.status === 'success') {
            document.getElementById(`display-${id}`).innerText = data.content;
            toggleEdit(id);
        } else {
            alert('Error saving reply');
        }
    });
}
</script>
{% endblock %}